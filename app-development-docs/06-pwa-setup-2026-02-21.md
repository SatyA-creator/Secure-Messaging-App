# 06 — PWA Setup
**Date:** 2026-02-21
**Author:** Engineering Team
**Project:** QuChat — Progressive Web App
**Status:** Implementation guide

---

## 1. What Is a PWA and Why QuChat Needs It

A Progressive Web App (PWA) is a web app that can be:
- **Installed** on Android/iOS home screen from the browser (no Play Store needed)
- **Used offline** or on slow networks (via service worker caching)
- **Receive push notifications** (via Web Push API)

For QuChat, PWA serves as:
1. A lower-friction distribution channel (share a URL, no Play Store account needed)
2. An offline-capable fallback for users on poor networks
3. A desktop "app" experience for users on PC/Mac

**PWA vs APK — when to use which:**

| Scenario | Recommended |
|----------|-------------|
| Play Store discovery | APK/AAB via Capacitor |
| Share with friend via link | PWA |
| Users on low-storage Android | PWA |
| Need native camera / notifications | APK (native plugins required) |
| Corporate deployment (MDM) | APK |
| Quick demo to stakeholders | PWA |
| Desktop users (Windows/Mac) | PWA |

The decision is not either/or — you publish both.

---

## 2. Current PWA Status

QuChat currently has **no PWA support**:
- No `manifest.webmanifest` file
- No service worker
- No `<link rel="manifest">` in `index.html`
- No icons in `public/` for PWA

All of this will be added in this section.

---

## 3. Install `vite-plugin-pwa`

This plugin auto-generates a service worker using Workbox and injects the manifest into your build:

```bash
npm install --save-dev vite-plugin-pwa
```

---

## 4. Configure `vite.config.ts`

```typescript
// vite.config.ts
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react-swc';
import path from 'path';
import { VitePWA } from 'vite-plugin-pwa';

export default defineConfig(({ mode }) => ({
  server: {
    host: '::',
    port: 8080,
    allowedHosts: ['.ngrok-free.dev', '.ngrok.io'],
  },
  plugins: [
    react(),
    VitePWA({
      registerType: 'autoUpdate',       // Auto-update service worker on new deploy
      injectRegister: 'auto',           // Inject SW registration script automatically

      // Web App Manifest
      manifest: {
        name: 'QuChat — Secure Messaging',
        short_name: 'QuChat',
        description: 'End-to-end encrypted messaging',
        theme_color: '#ffffff',
        background_color: '#ffffff',
        display: 'standalone',          // Hides browser chrome when installed
        orientation: 'portrait',
        scope: '/',
        start_url: '/',
        icons: [
          {
            src: 'icons/icon-72x72.png',
            sizes: '72x72',
            type: 'image/png',
          },
          {
            src: 'icons/icon-96x96.png',
            sizes: '96x96',
            type: 'image/png',
          },
          {
            src: 'icons/icon-128x128.png',
            sizes: '128x128',
            type: 'image/png',
          },
          {
            src: 'icons/icon-144x144.png',
            sizes: '144x144',
            type: 'image/png',
          },
          {
            src: 'icons/icon-192x192.png',
            sizes: '192x192',
            type: 'image/png',
            purpose: 'any maskable',
          },
          {
            src: 'icons/icon-512x512.png',
            sizes: '512x512',
            type: 'image/png',
            purpose: 'any maskable',
          },
        ],
      },

      // Workbox Service Worker Configuration
      workbox: {
        // App shell: cache-first for fast loads
        globPatterns: ['**/*.{js,css,html,ico,png,svg,woff2}'],

        runtimeCaching: [
          // API calls: network-first (always try fresh data)
          {
            urlPattern: /^https:\/\/secure-messaging-app-backend\.onrender\.com\/api\//,
            handler: 'NetworkFirst',
            options: {
              cacheName: 'api-cache',
              networkTimeoutSeconds: 10,
              expiration: {
                maxEntries: 50,
                maxAgeSeconds: 5 * 60,   // 5 minutes
              },
            },
          },
          // Media: stale-while-revalidate
          {
            urlPattern: /^https:\/\/secure-messaging-app-backend\.onrender\.com\/api\/v1\/media\//,
            handler: 'StaleWhileRevalidate',
            options: {
              cacheName: 'media-cache',
              expiration: {
                maxEntries: 100,
                maxAgeSeconds: 7 * 24 * 60 * 60,  // 7 days
              },
            },
          },
        ],

        // IMPORTANT: Do NOT cache WebSocket connections
        // Workbox cannot intercept WS anyway — this is just documentation
        navigateFallback: '/index.html',
        navigateFallbackDenylist: [/^\/api/, /^\/ws/],
      },

      devOptions: {
        enabled: true,              // Enable service worker in dev (for testing)
        type: 'module',
      },
    }),
  ],
  resolve: {
    alias: { '@': path.resolve(__dirname, './src') },
  },
  build: {
    target: 'esnext',
    chunkSizeWarningLimit: 2000,
  },
}));
```

---

## 5. Create PWA Icons

Create `public/icons/` directory and add icon images at required sizes.

Generate from a single 512×512px source using a tool like:
- https://realfavicongenerator.net/
- `sharp-cli`: `npx sharp-cli --input src/assets/icon.png --output public/icons/ resize 512` (etc.)

Required sizes for QuChat PWA:
```
public/
  icons/
    icon-72x72.png
    icon-96x96.png
    icon-128x128.png
    icon-144x144.png
    icon-192x192.png    ← most important
    icon-512x512.png    ← most important (used for install prompt)
```

---

## 6. Update `index.html`

```html
<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1.0" />

    <!-- PWA meta tags -->
    <meta name="theme-color" content="#ffffff" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="QuChat" />

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/icons/icon-192x192.png" />

    <!-- Apple touch icon (iOS PWA install) -->
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png" />

    <!-- vite-plugin-pwa auto-injects the manifest link and SW registration -->

    <title>QuChat</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
```

---

## 7. Add Install Prompt UI

Add a custom install button to your app. The browser fires a `beforeinstallprompt` event when the app is installable.

Create `src/components/chat/InstallPWAButton.tsx`:

```typescript
import { useState, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Download } from 'lucide-react';

interface BeforeInstallPromptEvent extends Event {
  prompt: () => Promise<void>;
  userChoice: Promise<{ outcome: 'accepted' | 'dismissed' }>;
}

export const InstallPWAButton = () => {
  const [installPrompt, setInstallPrompt] = useState<BeforeInstallPromptEvent | null>(null);
  const [isInstalled, setIsInstalled] = useState(false);

  useEffect(() => {
    // Check if already installed (running in standalone mode)
    if (window.matchMedia('(display-mode: standalone)').matches) {
      setIsInstalled(true);
      return;
    }

    const handler = (e: Event) => {
      e.preventDefault();
      setInstallPrompt(e as BeforeInstallPromptEvent);
    };

    window.addEventListener('beforeinstallprompt', handler);
    return () => window.removeEventListener('beforeinstallprompt', handler);
  }, []);

  const handleInstall = async () => {
    if (!installPrompt) return;
    await installPrompt.prompt();
    const { outcome } = await installPrompt.userChoice;
    if (outcome === 'accepted') {
      setIsInstalled(true);
      setInstallPrompt(null);
    }
  };

  if (isInstalled || !installPrompt) return null;

  return (
    <Button
      variant="outline"
      size="sm"
      onClick={handleInstall}
      className="gap-2"
    >
      <Download className="h-4 w-4" />
      Install App
    </Button>
  );
};
```

Add `<InstallPWAButton />` to your `Sidebar.tsx` or `Settings.tsx`.

---

## 8. Offline Caching Strategy Explained

```
Request type          → Workbox strategy     → Behaviour
─────────────────────────────────────────────────────────
App shell (JS/CSS)    → CacheFirst           → Serve from cache instantly; update in background
                                              → User always gets fast load even offline

API (REST calls)      → NetworkFirst         → Try network first; fall back to cache if offline
                                              → Ensures fresh data when online

Media files           → StaleWhileRevalidate → Serve from cache immediately; refresh in background
                                              → Good for profile pictures, uploaded images

WebSocket             → Not handled by SW    → WS bypasses service worker entirely
                                              → Real-time is lost offline (expected behaviour)
```

### What "offline" means for QuChat

| Feature | Online | Offline |
|---------|--------|---------|
| View cached messages | ✅ | ✅ (from IndexedDB via Dexie) |
| Send new messages | ✅ | ⏳ (queued in offlineQueue.ts) |
| Receive new messages | ✅ | ❌ (WebSocket unavailable) |
| Media upload | ✅ | ❌ (requires server) |
| View previously loaded media | ✅ | ✅ (SW media cache) |
| Auth/login | ✅ | ❌ (requires server) |

The existing `offlineQueue.ts` already handles queuing outgoing messages — this integrates naturally with PWA offline mode.

---

## 9. Service Worker Lifecycle (What You Need to Know)

```
User visits app (first time)
         │
         ▼
SW installs → caches app shell
         │
         ▼
User visits app (subsequent times)
         │
         ├─ SW intercepts fetch requests
         ├─ Serves from cache (fast)
         └─ Updates cache in background

New version deployed
         │
         ▼
New SW installs (background)
         │
         ▼
Waiting... (old SW still active)
         │
         ▼ (registerType: 'autoUpdate' handles this automatically)
Old tab closes / user refreshes
         │
         ▼
New SW activates → new cache
```

With `registerType: 'autoUpdate'` in `vite-plugin-pwa`, the update happens automatically. You can also show a "New version available — refresh" toast to users:

```typescript
// src/main.tsx
import { registerSW } from 'virtual:pwa-register';

registerSW({
  onNeedRefresh() {
    // Show a toast: "Update available — click to refresh"
    toast('New version available', {
      action: {
        label: 'Update',
        onClick: () => window.location.reload(),
      },
    });
  },
  onOfflineReady() {
    toast('App ready for offline use');
  },
});
```

---

## 10. Testing PWA

### Lighthouse Audit

```bash
npm run build
npm run preview  # serves from dist/ on localhost:4173
```

Open Chrome, go to `http://localhost:4173`, open DevTools → Lighthouse → select Progressive Web App → run audit.

**Target score:** 90+. Common issues to fix:
- All pages respond with 200 when offline ✓ (navigateFallback handles this)
- `start_url` responds with 200 while offline ✓
- Icons with correct sizes ✓
- Viewport meta set ✓
- HTTPS ✓ (production deployment)

### Browser DevTools — Application Tab

DevTools → Application → Service Workers: verify SW is installed and active.
DevTools → Application → Cache Storage: verify app shell files are cached.
DevTools → Application → Manifest: verify manifest is correctly parsed.

### Test Offline Mode

1. DevTools → Network → check "Offline" checkbox.
2. Reload the app — it should load from cache.
3. Try to send a message — it should be queued by `offlineQueue.ts`.
4. Uncheck Offline — queued message should send.

---

## 11. PWA on iOS (Safari)

iOS PWA support is more limited:
- Install via Safari share sheet → "Add to Home Screen"
- No `beforeinstallprompt` event on iOS
- Background sync not supported
- Push notifications: supported from iOS 16.4+ via Web Push

For iOS install prompt, add instructions to your UI:

```typescript
// Detect iOS
const isIOS = /iphone|ipad|ipod/.test(navigator.userAgent.toLowerCase());
const isStandalone = window.matchMedia('(display-mode: standalone)').matches;

if (isIOS && !isStandalone) {
  // Show toast: "To install: tap Share → Add to Home Screen"
}
```

---

## 12. PWA vs Capacitor APK — Feature Matrix

| Feature | PWA | Capacitor APK |
|---------|-----|---------------|
| Install without app store | ✅ | ❌ |
| Works on all browsers | ✅ | ❌ |
| Native camera access | Partial (browser API) | ✅ (full native) |
| Push notifications | ✅ (Web Push) | ✅ (FCM) |
| Background processing | Limited | ✅ |
| File system access | Limited | ✅ |
| App store discoverability | ❌ | ✅ |
| Offline support | ✅ | ✅ |
| E2E crypto (IndexedDB) | ✅ | ✅ |
| WebSocket real-time | ✅ | ✅ |
| Auto-updates | ✅ (SW) | Requires store update |
